<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../json-transform/json-transform.html">
<link rel="import" href="../lodash-import/lodash.html">

<!--
A Polymer Element that makes a POST request via `<iron-ajax>` element and
transforms the data returned with a function specified by the user.

### Example
```html
    <query-transformer
      search-on-empty-params
      error="{{searchError}}"
      loading="{{searchLoading}}"
      page="1"
      page-size="5"
      process-request="[[processRequest]]"
      result-function="[[resultFunction]]"
      results="{{searchResults}}"
      total="{{totalCount}}"
      search-parameters="[[searchParameters]]"
      search-function="[[searchFunction]]"
      url="http://localhost:9200/mockads/ad/_search">
    </query-transformer>
```

@demo demo/index.html
-->

<dom-module id="query-transformer">
  <template>
    <iron-ajax
      auto="[[_exists(_body)]]"
      url="[[url]]"
      method="POST"
      content-type="application/json"
      body="[[_body]]"
      loading="{{loading}}"
      last-response="{{_response}}"
      last-error="{{error}}">
    </iron-ajax>

    <json-transform
      data-in="[[_response]]"
      data-out="{{total}}"
      transform-function="[[_createTotalCountTransformFunction()]]">
    </json-transform>

    <json-transform
      data-in="[[_response]]"
      data-out="{{results}}"
      transform-function="[[resultFunction]]">
    </json-transform>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'query-transformer',

      properties: {

        /**
         * (Optional)
         *
         * Whether or not to create new iron-ajax request when searchParameters is empty.
         *
         * @type {Boolean}
         * @default false
         */
        searchOnEmptyParams: {
          type: Boolean,
          value: false
        },

        /**
         * (Output)
         *
         * Error returned from `<iron-ajax>` request (if any).
         *
         * @type {Object}
         */
        error: {
          notify: true,
          type: Object
        },

        /**
         * (Output)
         *
         * Whether or not a response is currently being loaded from iron-ajax.
         *
         * @type {Boolean}
         */
        loading: {
          notify: true,
          type: Boolean
        },

        /**
         * (Optional)
         *
         * The number of the current page of search results. Expected parameter
         * in searchFunction.
         *
         * @type {Number}
         * @default 1
         */
        page: {
          type: Number,
          value: 1,
          notify: true
        },

        /**
         * (Optional)
         *
         * The current page size for search results. Expected parameter
         * in searchFunction.
         *
         * @type {Number}
         * @default 25
         */
        pageSize: {
          type: Number,
          value: 25
        },

        /**
         * (Required)
         *
         * Whether or not to create new iron-ajax request.
         *
         * @type {Boolean}
         */
        processRequest: {
          type: Boolean
        },

        /**
         * (Required)
         *
         * Function to apply to response returned by iron-ajax request.
         *
         * @type {Object}
         */
        resultFunction: {
          type: Object
        },

        /**
         * (Output)
         *
         * The query results.
         *
         * @type {Object}
         */
        results: {
          notify: true,
          type: Object
        },

        /**
         * (Required)
         *
         * Function used to create request sent to iron-ajax. Takes the following three properties
         * as arguments in this order:
         * - page
         * - pageSize
         * - searchParameters
         *
         * @type {Object}
         */
        searchFunction: {
          type: Object
        },

        /**
         * (Required)
         *
         * Name for enabled property in searchParameters values.
         *
         * @type {String}
         * @default 'enabled'
         */
        searchParameterEnabledProperty: {
          type: String,
          value: 'enabled'
        },

        /**
         * (Required)
         *
         * Function used to create request sent to iron-ajax. Expected parameter in searchFunction.
         * Example structure:
         *
         * {
         *    city: {
         *      'NYC': {
         *        category: 'City',
         *        enabled: true,
         *        key: 'NYC',
         *        text: 'NYC'
         *      }
         *    },
         *    state: {},
         *    zip: {}
         * }
         *
         * This structure can be customized. See the searchParameterEnabledProperty as well as the
         * following DigElements: selected-facets-display, terms-transformer, and date-picker-display
         * for more information.
         *
         * @type {Object}
         */
        searchParameters: {
          type: Object
        },

        /**
         * (Output)
         *
         * The total count of query results.
         *
         * @type {Number}
         * @default 0
         */
        total: {
          notify: true,
          type: Number,
          value: 0
        },

        /**
         * (Required)
         *
         * The URL target of the request.
         *
         * @type {String}
         */
        url: {
          type: String
        },

        /**
         * Request to pass along to iron-ajax element.
         *
         * @type {Object}
         * @private
         */
        _body: {
          type: Object
        },

        /**
         * Response returned from iron-ajax.
         *
         * @type {Object}
         * @private
         */
        _response: {
          type: Object
        }
      },

      observers: [
        '_resetPage(searchParameters.*)',
        '_transform(searchOnEmptyParams, page, pageSize, processRequest, searchFunction, searchParameters.*)'
      ],

      /**
       * Returns whether all the items in the searchParameters collection are disabled.
       *
       * @param {Object} searchParameters
       * @return {Boolean} disabled
       * @private
       */
      _areAllDisabled: function(searchParameters) {
        var self = this;
        return _.keys(searchParameters).every(function(type) {
          if(_.isEmpty(searchParameters[type])) {
            return true;
          }
          return _.keys(searchParameters[type]).every(function(term) {
            return !searchParameters[type][term][self.searchParameterEnabledProperty];
          });
        });
      },

      /**
       * Returns the transform function for the total count.
       *
       * @return {Function}
       * @private
       */
      _createTotalCountTransformFunction: function() {
        var self = this;
        return function(data) {
          var total = data && data.length && data[0] && data[0].result && data[0].result.hits && data[0].result.hits.total ? data[0].result.hits.total : 0;
          // Only returning the total doesn't work all the time (for unknown reasons) so just set it here as well.
          self.set('total', total);
          return total;
        };
      },

      /**
       * Returns a boolean to indicate whether or not an object is defined.
       *
       * @param {Object} object
       * @return {Boolean} exists
       * @private
       */
      _exists: function(object) {
        return !!object;
      },

      /**
       * Creates request for `<iron-ajax>` element based on different properties.
       *
       * @private
       */
      _transform: function() {
        if(this.processRequest && this.searchFunction) {
          var noSearchParameters = this._areAllDisabled(this.searchParameters);

          this.set('error', null);
          this.set('results', null);
          this.set('total', 0);

          if(noSearchParameters && !this.searchOnEmptyParams) {
            return;
          }

          this.set('_body', this.searchFunction(this.page, this.pageSize, this.searchParameters));
        }
      },

      /**
       * Resets page value to 1.
       *
       * @private
       */
      _resetPage: function() {
        this.page = 1;
      }
    });
  })();
  </script>
</dom-module>
